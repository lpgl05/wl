# 平行样品处理逻辑变更说明

## 变更日期
2025年10月30日

## 变更内容

### ✅ 新的处理逻辑

**平行样品现在作为独立的样品编号处理**

---

## 详细说明

### 1️⃣ 样品编号匹配规则

#### 变更前 (旧逻辑):
```python
# 用户输入: "DX2509530101"
# 会匹配:
- DX2509530101        ✅
- DX2509530101平行1   ✅ (去除"平行1"后匹配)
- DX2509530101平行2   ✅ (去除"平行2"后匹配)
```

#### 变更后 (新逻辑):
```python
# 用户输入: "DX2509530101"
# 只匹配:
- DX2509530101        ✅

# 用户必须明确输入:
用户输入: "DX2509530101平行1"
- DX2509530101平行1   ✅ (精确匹配)
```

---

### 2️⃣ 空值处理规则

#### 变更前 (旧逻辑):
```
Excel数据:
DX2509530101平行1  → 浓度: 101
DX2509530101平行2  → 浓度: NaN (空)

处理后:
DX2509530101平行1  → 浓度: 101
DX2509530101平行2  → 浓度: 101 (自动填充)
```

#### 变更后 (新逻辑):
```
Excel数据:
DX2509530101平行1  → 浓度: 101
DX2509530101平行2  → 浓度: NaN (空)

处理后:
DX2509530101平行1  → 浓度: 101
DX2509530101平行2  → 浓度: NaN (保持空值)
```

---

## 代码修改点

### 修改1: `_normalize_sample_id()` 函数

**位置**: 第31-48行

**修改内容**:
```python
# 变更前: 去除"平行X"字样
s = re.sub(r"平行[0-9]+", "", s)

# 变更后: 保留"平行X"字样
# s = re.sub(r"平行[0-9]+", "", s)  # 已禁用
```

---

### 修改2: 删除平行样品空值填充逻辑

**位置**: 第479-494行

**删除的逻辑**:
```python
# 已删除以下代码:
for i, row in enumerate(result_array):
    if '250953' in str(row[0]) and 'KB' not in str(row[0]) and 'PS' not in str(row[0]):
        if '平行' in str(row[0]) and pd.isna(row[1]):
            # 向前/向后查找并填充浓度值
            ...
```

**替换为**:
```python
# 注意：平行样品现在作为独立样品处理
# - 不再填充平行样品的空值
# - 不再去除"平行X"字样
# - 浓度为空时保持空值(NaN)
```

---

## 使用示例

### 示例1: 提取单个样品及其平行样品

**Excel数据**:
```
样品编号                 浓度
DX2509530101           105
DX2509530101平行1      101
DX2509530101平行2      NaN
DX2509530102           88
```

**用户输入编号**:
```
DX2509530101, DX2509530101平行1, DX2509530101平行2
```

**提取结果**:
```
样品编号                 浓度
DX2509530101           105
DX2509530101平行1      101
DX2509530101平行2      NaN  ← 保持空值
```

---

### 示例2: 只提取主样品(不含平行)

**Excel数据**:
```
样品编号                 浓度
DX2509530101           105
DX2509530101平行1      101
DX2509530101平行2      100
```

**用户输入编号**:
```
DX2509530101
```

**提取结果**:
```
样品编号                 浓度
DX2509530101           105
```
(平行样品不会被提取)

---

### 示例3: 只提取平行样品

**用户输入编号**:
```
DX2509530101平行1
```

**提取结果**:
```
样品编号                 浓度
DX2509530101平行1      101
```
(只提取指定的平行样品)

---

## 注意事项

1. ⚠️ **必须明确指定**: 如果要提取平行样品,必须在输入编号时包含"平行1"、"平行2"等完整字样

2. ⚠️ **空值不填充**: 如果平行样品的浓度为空,将保持空值,不会自动从其他平行样品填充

3. ⚠️ **独立匹配**: 每个样品编号(包括平行样品)都作为独立的编号进行精确匹配

4. ✅ **批量输入**: 可以同时输入多个编号,包括主样品和平行样品
   ```
   示例: DX2509530101, DX2509530101平行1, DX2509530101平行2
   ```

---

## 迁移建议

如果之前使用旧逻辑,迁移到新逻辑时需要注意:

### 旧逻辑用法:
```
输入: DX2509530101
结果: 自动匹配主样品 + 所有平行样品
```

### 新逻辑用法:
```
输入: DX2509530101, DX2509530101平行1, DX2509530101平行2
结果: 明确匹配指定的样品
```

建议使用TXT文件导入编号,便于批量管理:
```txt
DX2509530101
DX2509530101平行1
DX2509530101平行2
DX2509530102
DX2509530102平行1
```

---

## 优势

✅ **更精确**: 明确控制要提取哪些样品  
✅ **更灵活**: 可以选择性提取平行样品  
✅ **更透明**: 空值不被隐藏填充,保持数据真实性  
✅ **更可控**: 避免意外匹配不需要的平行样品

---

## 测试建议

运行程序并测试以下场景:

1. ✅ 只输入主样品编号,验证不会匹配平行样品
2. ✅ 输入平行样品编号,验证能精确匹配
3. ✅ 输入多个编号(主+平行),验证都能提取
4. ✅ 验证空值平行样品不会被自动填充

测试命令:
```powershell
python.exe .\main.py
```
